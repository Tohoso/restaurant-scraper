#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Restaurant Scraper Initialization Script
åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - SerenaMCP & Project Setup
"""

import os
import sys
import json
import subprocess
from datetime import datetime
from pathlib import Path

def print_banner():
    """Print initialization banner"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       é£²é£Ÿåº—å–¶æ¥­ãƒªã‚¹ãƒˆä½œæˆã‚¢ãƒ—ãƒª - åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ       â•‘
â•‘            Restaurant Scraper Initialization              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

def check_environment():
    """Check system environment"""
    print("ğŸ” ç’°å¢ƒãƒã‚§ãƒƒã‚¯ä¸­...")
    
    # Python version
    version = sys.version_info
    print(f"  Python: {version.major}.{version.minor}.{version.micro}")
    
    if version.major < 3 or (version.major == 3 and version.minor < 8):
        print("  âŒ Python 3.8ä»¥ä¸ŠãŒå¿…è¦ã§ã™")
        return False
    
    # Check if in correct directory
    cwd = Path.cwd()
    if not (cwd / "restaurant_scraper_app.py").exists():
        print("  âŒ restaurant_scraper_app.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        print("  æ­£ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œã—ã¦ãã ã•ã„")
        return False
    
    print("  âœ… ç’°å¢ƒãƒã‚§ãƒƒã‚¯å®Œäº†")
    return True

def install_dependencies():
    """Install dependencies"""
    print("\nğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«...")
    
    if (Path.cwd() / "setup.py").exists():
        result = subprocess.run([sys.executable, "setup.py"], capture_output=True, text=True)
        if result.returncode == 0:
            print("  âœ… ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†")
            return True
        else:
            print("  âŒ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
            print(result.stderr)
            return False
    else:
        print("  âŒ setup.pyãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return False

def create_directories():
    """Create necessary directories"""
    print("\nğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ...")
    
    dirs = [
        ".serena",
        "logs",
        "output",
        "cache"
    ]
    
    for dir_name in dirs:
        dir_path = Path.cwd() / dir_name
        if not dir_path.exists():
            dir_path.mkdir(exist_ok=True)
            print(f"  âœ… {dir_name}/ ã‚’ä½œæˆã—ã¾ã—ãŸ")
        else:
            print(f"  â„¹ï¸  {dir_name}/ ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™")

def create_config_files():
    """Create configuration files"""
    print("\nâš™ï¸  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ...")
    
    # Create .gitignore if not exists
    gitignore_path = Path.cwd() / ".gitignore"
    if not gitignore_path.exists():
        gitignore_content = """# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
.env

# Logs
*.log
logs/

# Output
output/
*.xlsx
*.csv

# Cache
cache/
.cache/

# IDE
.vscode/
.idea/
*.swp
*.swo

# macOS
.DS_Store

# SerenaMCP
.serena/cache/
"""
        with open(gitignore_path, 'w') as f:
            f.write(gitignore_content)
        print("  âœ… .gitignoreã‚’ä½œæˆã—ã¾ã—ãŸ")
    
    # Create sample .env
    env_sample_path = Path.cwd() / ".env.sample"
    if not env_sample_path.exists():
        env_content = """# Restaurant Scraper Environment Variables
# Copy to .env and fill in your values

# HotPepper API Key (optional)
HOTPEPPER_API_KEY=

# Default settings
DEFAULT_AREA=æ±äº¬éƒ½
MAX_RESTAURANTS_PER_AREA=100
OUTPUT_FILENAME=restaurant_list.xlsx

# Scraping settings
TABELOG_DELAY_MIN=2
TABELOG_DELAY_MAX=4
USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

# Logging
LOG_LEVEL=INFO
LOG_FILE=logs/restaurant_scraper.log
"""
        with open(env_sample_path, 'w') as f:
            f.write(env_content)
        print("  âœ… .env.sampleã‚’ä½œæˆã—ã¾ã—ãŸ")

def create_quick_start_script():
    """Create quick start script"""
    print("\nğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ...")
    
    script_path = Path.cwd() / "run.sh"
    script_content = """#!/bin/bash

# Restaurant Scraper Quick Start Script

echo "ğŸ½ï¸ é£²é£Ÿåº—å–¶æ¥­ãƒªã‚¹ãƒˆä½œæˆã‚¢ãƒ—ãƒª"
echo "================================"
echo ""

# Check if Python is installed
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
    exit 1
fi

# Run in interactive mode by default
python3 restaurant_scraper_app.py -i
"""
    
    with open(script_path, 'w') as f:
        f.write(script_content)
    
    # Make executable
    os.chmod(script_path, 0o755)
    print("  âœ… run.shã‚’ä½œæˆã—ã¾ã—ãŸ")

def test_application():
    """Test basic application functionality"""
    print("\nğŸ§ª ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆ...")
    
    try:
        # Import test
        sys.path.insert(0, str(Path.cwd()))
        from restaurant_scraper_app import RestaurantScraperApp
        from hotpepper_api_client import HotpepperAPIClient
        from tabelog_scraper_improved import TabelogScraperImproved
        from restaurant_data_integrator import RestaurantDataIntegrator
        
        # Create instances
        app = RestaurantScraperApp()
        
        print("  âœ… ã™ã¹ã¦ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸ")
        print("  âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸ")
        return True
        
    except Exception as e:
        print(f"  âŒ ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return False

def create_usage_guide():
    """Create usage guide"""
    print("\nğŸ“– ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ã®ä½œæˆ...")
    
    guide_path = Path.cwd() / "USAGE.md"
    guide_content = f"""# é£²é£Ÿåº—å–¶æ¥­ãƒªã‚¹ãƒˆä½œæˆã‚¢ãƒ—ãƒª ä½¿ç”¨ã‚¬ã‚¤ãƒ‰

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¨å¥¨ï¼‰
```bash
./run.sh
```
ã¾ãŸã¯
```bash
python3 restaurant_scraper_app.py -i
```

### ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰
```bash
# æ±äº¬éƒ½ã®é£²é£Ÿåº—ã‚’50ä»¶å–å¾—
python3 restaurant_scraper_app.py --areas æ±äº¬éƒ½ --max-per-area 50

# è¤‡æ•°åœ°åŸŸã‹ã‚‰å–å¾—
python3 restaurant_scraper_app.py --areas æ±äº¬éƒ½ å¤§é˜ªåºœ ç¥å¥ˆå·çœŒ --max-per-area 100
```

## ğŸ“ åˆæœŸåŒ–å®Œäº†æƒ…å ±

- **åˆæœŸåŒ–æ—¥æ™‚**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
- **Python ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: {sys.version.split()[0]}
- **ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: {Path.cwd()}

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
restaurant-scraper/
â”œâ”€â”€ restaurant_scraper_app.py    # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ hotpepper_api_client.py      # ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼API
â”œâ”€â”€ tabelog_scraper_improved.py  # é£Ÿã¹ãƒ­ã‚°ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼
â”œâ”€â”€ restaurant_data_integrator.py # ãƒ‡ãƒ¼ã‚¿çµ±åˆ
â”œâ”€â”€ .serena/                     # SerenaMCPè¨­å®š
â”œâ”€â”€ logs/                        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ output/                      # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ cache/                       # ã‚­ãƒ£ãƒƒã‚·ãƒ¥
â””â”€â”€ run.sh                       # ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. Python 3.8ä»¥ä¸ŠãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹
2. ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹
3. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒæœ‰åŠ¹ã‹
4. `logs/`ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

READMEãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
"""
    
    with open(guide_path, 'w') as f:
        f.write(guide_content)
    print("  âœ… USAGE.mdã‚’ä½œæˆã—ã¾ã—ãŸ")

def main():
    """Main initialization function"""
    print_banner()
    
    # Check environment
    if not check_environment():
        print("\nâŒ åˆæœŸåŒ–ã‚’ä¸­æ–­ã—ã¾ã—ãŸ")
        return False
    
    # Install dependencies
    if not install_dependencies():
        print("\nâŒ åˆæœŸåŒ–ã‚’ä¸­æ–­ã—ã¾ã—ãŸ")
        return False
    
    # Create directories
    create_directories()
    
    # Create config files
    create_config_files()
    
    # Create quick start script
    create_quick_start_script()
    
    # Test application
    if not test_application():
        print("\nâš ï¸  è­¦å‘Š: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ")
        print("  ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„: python3 setup.py")
    
    # Create usage guide
    create_usage_guide()
    
    # Success message
    print("\n" + "="*60)
    print("âœ¨ åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    print("="*60)
    print("\nğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:")
    print("  1. å¯¾è©±ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ: ./run.sh")
    print("  2. ã¾ãŸã¯: python3 restaurant_scraper_app.py -i")
    print("  3. è©³ç´°ã¯USAGE.mdã‚’å‚ç…§ã—ã¦ãã ã•ã„")
    print("\nğŸ’¡ ãƒ’ãƒ³ãƒˆ: ãƒ›ãƒƒãƒˆãƒšãƒƒãƒ‘ãƒ¼APIã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ã€")
    print("  .env.sampleã‚’.envã«ã‚³ãƒ”ãƒ¼ã—ã¦APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„")
    
    return True

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)